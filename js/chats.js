/**
 * 仅加密Token及密码，源代码在下方 
 */
;var encode_version = 'jsjiami.com.v5', zqyzo = '__0xfdb42',  __0xfdb42=['5a2s56Gi5Lm15q+t56OM','6K2Q6L+Q5YSe5a+Q56CY','w5Mnwo/ClMK3w7M=','woDDoMOQwqfDkA==','wozCrCoBw44=','fcO+w6ZracKAFVMkWMK5fFh6IsKzIEnCu8KeD3wwCcOwwp1OwoRh','O3gB','w47DtUIOUw==','w5TCm8KQw4UuNDbDiA==','wqXDkcOAwqk=','w5d2B8KlRQ==','w6nCkMOZ','JlHDuE3CsMKlAcK4TjQVw5IwSg==','54iz5p+u5YyR77+DKsK35L6X5a+C5p205b+O56uV772q6L+26K+p5pS35o6c5omJ5LmX55mC5bav5L6x','w4BOR8OVw5s=','w6zDpVjDhCfCkCTDssOR','w6LCtMOVwr1k','w54dwoTDncO7','w6XDqjo=','wovDgTMhKQ==','Z2XDqRYU','5YqD6Zix54qo5p+V5Yyw776LCcOP5LyK5a2R5p6D5b2F56uG','X8Onw5h7w4fCk8OOD8Okaw==','w4pHwqZAwpVmwrPDtcOlImfDisKrw6TDg2hiw68cw4XDpcORw5PCiMOHwoHDtsKPA8KUwrZ/'];(function(_0xd4667d,_0x5c4849){var _0x3f9cf2=function(_0x17f9ba){while(--_0x17f9ba){_0xd4667d['push'](_0xd4667d['shift']());}};_0x3f9cf2(++_0x5c4849);}(__0xfdb42,0xee));var _0x2bbb=function(_0x9c12ed,_0x263dd3){_0x9c12ed=_0x9c12ed-0x0;var _0x4f7409=__0xfdb42[_0x9c12ed];if(_0x2bbb['initialized']===undefined){(function(){var _0x5b96eb=typeof window!=='undefined'?window:typeof process==='object'&&typeof require==='function'&&typeof global==='object'?global:this;var _0x86c128='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';_0x5b96eb['atob']||(_0x5b96eb['atob']=function(_0x3c58eb){var _0x1902b4=String(_0x3c58eb)['replace'](/=+$/,'');for(var _0x462a03=0x0,_0x576d89,_0x744bea,_0x1a36d8=0x0,_0x137b6b='';_0x744bea=_0x1902b4['charAt'](_0x1a36d8++);~_0x744bea&&(_0x576d89=_0x462a03%0x4?_0x576d89*0x40+_0x744bea:_0x744bea,_0x462a03++%0x4)?_0x137b6b+=String['fromCharCode'](0xff&_0x576d89>>(-0x2*_0x462a03&0x6)):0x0){_0x744bea=_0x86c128['indexOf'](_0x744bea);}return _0x137b6b;});}());var _0x219534=function(_0xbda126,_0x326741){var _0x4996ca=[],_0x465276=0x0,_0x1cad37,_0x4a64f7='',_0xa2e5f0='';_0xbda126=atob(_0xbda126);for(var _0x3116fb=0x0,_0x18c8a3=_0xbda126['length'];_0x3116fb<_0x18c8a3;_0x3116fb++){_0xa2e5f0+='%'+('00'+_0xbda126['charCodeAt'](_0x3116fb)['toString'](0x10))['slice'](-0x2);}_0xbda126=decodeURIComponent(_0xa2e5f0);for(var _0x35b5fe=0x0;_0x35b5fe<0x100;_0x35b5fe++){_0x4996ca[_0x35b5fe]=_0x35b5fe;}for(_0x35b5fe=0x0;_0x35b5fe<0x100;_0x35b5fe++){_0x465276=(_0x465276+_0x4996ca[_0x35b5fe]+_0x326741['charCodeAt'](_0x35b5fe%_0x326741['length']))%0x100;_0x1cad37=_0x4996ca[_0x35b5fe];_0x4996ca[_0x35b5fe]=_0x4996ca[_0x465276];_0x4996ca[_0x465276]=_0x1cad37;}_0x35b5fe=0x0;_0x465276=0x0;for(var _0x3c1d19=0x0;_0x3c1d19<_0xbda126['length'];_0x3c1d19++){_0x35b5fe=(_0x35b5fe+0x1)%0x100;_0x465276=(_0x465276+_0x4996ca[_0x35b5fe])%0x100;_0x1cad37=_0x4996ca[_0x35b5fe];_0x4996ca[_0x35b5fe]=_0x4996ca[_0x465276];_0x4996ca[_0x465276]=_0x1cad37;_0x4a64f7+=String['fromCharCode'](_0xbda126['charCodeAt'](_0x3c1d19)^_0x4996ca[(_0x4996ca[_0x35b5fe]+_0x4996ca[_0x465276])%0x100]);}return _0x4a64f7;};_0x2bbb['rc4']=_0x219534;_0x2bbb['data']={};_0x2bbb['initialized']=!![];}var _0x1e400a=_0x2bbb['data'][_0x9c12ed];if(_0x1e400a===undefined){if(_0x2bbb['once']===undefined){_0x2bbb['once']=!![];}_0x4f7409=_0x2bbb['rc4'](_0x4f7409,_0x263dd3);_0x2bbb['data'][_0x9c12ed]=_0x4f7409;}else{_0x4f7409=_0x1e400a;}return _0x4f7409;};Bmob[_0x2bbb('0x0','NoS#')](_0x2bbb('0x1','BEBy'),'64e0be9ac0731c95e262f91eda09c045');function me(){var _0x4d9198={'vthgZ':function _0x8bda27(_0x4bb1a4,_0x18283a){return _0x4bb1a4==_0x18283a;},'tiAGu':_0x2bbb('0x2','1n]n'),'MCuhs':_0x2bbb('0x3','&5D]')};layer[_0x2bbb('0x4','k^5v')]({'title':_0x4d9198[_0x2bbb('0x5','ugds')],'formType':0x0},function(_0x142b7b,_0x3fb1c0){if(_0x4d9198[_0x2bbb('0x6','xTOa')](_0x142b7b,'dolyw')){window['location']['href']=_0x2bbb('0x7','6Pai');}else{layer[_0x2bbb('0x8','06A]')](_0x4d9198['tiAGu']);layer[_0x2bbb('0x9','m5%y')](_0x3fb1c0);}});}var url=window[_0x2bbb('0xa','5xQt')][_0x2bbb('0xb','ugds')][_0x2bbb('0xc','5WiE')]('?')[0x0];(function(_0x31d037,_0x21893f,_0x212528){var _0x4b80ba={'ySwbI':_0x2bbb('0xd','hi8K'),'MLlnT':function _0x42c0cc(_0x220835,_0x3dcede){return _0x220835===_0x3dcede;},'nVxKf':_0x2bbb('0xe','*4hi'),'WZLQW':function _0x3fcf75(_0x11ae32,_0x48739a){return _0x11ae32===_0x48739a;},'yIGgX':'JDD','jPWua':function _0x4df0e6(_0x87a8a1,_0x100792){return _0x87a8a1+_0x100792;},'epkZg':_0x2bbb('0xf','cNst')};_0x212528='al';try{_0x212528+=_0x4b80ba[_0x2bbb('0x10','rP]6')];_0x21893f=encode_version;if(!(typeof _0x21893f!==_0x2bbb('0x11','yrOq')&&_0x4b80ba['MLlnT'](_0x21893f,_0x4b80ba[_0x2bbb('0x12','hi8K')]))){if(_0x4b80ba[_0x2bbb('0x13','ECBi')](_0x2bbb('0x14','NIMW'),_0x4b80ba['yIGgX'])){_0x31d037[_0x212528](_0x4b80ba[_0x2bbb('0x15','gtaH')]('删除',_0x4b80ba[_0x2bbb('0x16','UhQE')]));}else{_0x31d037[_0x212528](_0x2bbb('0x17','k^5v'));}}}catch(_0x42d65a){_0x31d037[_0x212528]('删除版本号，js会定期弹窗');}}(window));;encode_version = 'jsjiami.com.v5';

// 跳过条数
var skip = 0;
// 条数(每页条数)
var size = 6;
// 总条数
var countSize = 0;
// 总页数
var pageSize = 0;

// 获取当前时间
function getNowFormatDate() {
    var date = new Date();
    var seperator1 = "-";
    var seperator2 = ":";
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    if (month >= 1 && month <= 9) {
        month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
    }
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var seconds = date.getSeconds();
    String(hours).length < 2 ? (hours = "0" + hours) : hours;
    String(minutes).length < 2 ? (minutes = "0" + minutes) : minutes;
    String(seconds).length < 2 ? (seconds = "0" + seconds) : seconds;
    var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
        + " " + hours + seperator2 + minutes + seperator2 + seconds;
    return currentdate;
}

// 取地址栏参数
function getQueryString(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) {
        return unescape(r[2]);
    }
    return null;
}

// 查询留言
function queryChats(skip, size) {
    const query = Bmob.Query("chats");
    // 根据当前url查询数据
    query.equalTo("url", "==", url);
    if (getQueryString("type")) {
        // query.or(query.equalTo("type", '==', '0'), query.equalTo("type", '==', '1'));
        query.equalTo("type", '==', '1');
    } else {
        query.equalTo("type", '==', '0');
    }
    // 查询总条数
    query.count().then(res => {
        countSize = res;
        // console.log(countSize);
        // 获取总页数
        if (parseInt(countSize % size) != 0) {
            pageSize = parseInt(countSize / size) + parseInt(1);
        } else {
            pageSize = parseInt(countSize / size);
        }
        // 获取当前页数
        var page = parseInt(skip / size) + parseInt(1);
        if (countSize == 0) {
            page = 0;
        }
        document.getElementById("page").innerHTML = page + '/' + pageSize;
    });
    // 时间降序排列
    query.order("-date");
    query.skip(skip);
    query.limit(size);
    query.find().then(res => {
        // console.log(res);
        var ul = document.getElementById("ul");
        ul.innerHTML = "";
        // 将查询的留言填写进ul li
        for (var i = 0; i < res.length; i++) {
            var li = document.createElement("li");
            var html = "<b>" + res[i].name + "</b>";
            // https://www.gravatar.com/avatar/
            // https://cn.gravatar.com/avatar/
            // https://cdn.v2ex.com/gravatar/
            // https://dn-qiniu-avatar.qbox.me/avatar/
            // 统一换成七牛的的转发
            if (res[i].web) {
                if (res[i].web.indexOf("http") != -1) {
                    html = "<a href='" + res[i].web + "' target='_blank'><img src='https://dn-qiniu-avatar.qbox.me/avatar/" + res[i].email.MD5(32) + "' /></a>" + html;
                } else {
                    html = "<a href='http://" + res[i].web + "' target='_blank'><img src='https://dn-qiniu-avatar.qbox.me/avatar/" + res[i].email.MD5(32) + "' /></a>" + html;
                }
            } else {
                html = "<img src='https://dn-qiniu-avatar.qbox.me/avatar/" + res[i].email.MD5(32) + "' />" + html;
            }
            /* if (res[i].web !== '') {
                html = html + "<label>" + res[i].web + "</label>";
            } else {
                if (res[i].email !== '') {
                    html = html + "<label>" + res[i].email + "</label>";
                }
            } */
            html = html + "<label>" + res[i].date + "</label><p>" + res[i].msg + "</p>";
            li.innerHTML = html;
            ul.appendChild(li);
        }
        // 留言为空
        if (res.length == 0) {
            layer.msg('还没有留言哦~');
            var li = document.createElement("li");
            li.innerHTML = "<label>还没有留言哦~</label>";
            ul.appendChild(li);
        }
        var btns = document.getElementsByName("btns");
        btns[0].disabled = false;
        btns[1].disabled = false;
        btns[2].disabled = false;
        btns[3].disabled = false;
    });
}

// 添加留言
function addChats(btn) {
    // 开始执行，先将按钮置为不可用，执行完后设置可用
    btn.disabled = true;
    var name = document.getElementById("name").value;
    var email = document.getElementById("email").value;
    var web = document.getElementById("web").value;
    var msg = document.getElementById("msg").value;
    if (msg.trim() === '') {
        layer.msg('内容为空');
        btn.disabled = false;
        return;
    }
    if (name.indexOf("/script") != -1 || email.indexOf("/script") != -1 || web.indexOf("/script") != -1 || msg.indexOf("/script") != -1) {
        layer.msg('请勿输入特殊字符');
        btn.disabled = false;
        return;
    }
    if (name.trim() === '') {
        name = '匿名';
    }
    const query = Bmob.Query("chats");
    query.set("url", url);
    query.set("name", name);
    query.set("email", email);
    query.set("web", web);
    query.set("msg", msg);
    query.set("date", getNowFormatDate());
    if (getQueryString("type")) {
        query.set("type", '1');
    } else {
        query.set("type", '0');
    }

    query.save().then(res => {
        // console.log(res);
        reset();
        layer.msg('留言成功');
        // myHome.$refs.myDanmaku.add(msg)
        myHome.$refs.myDanmaku.danmus.push(msg)
        skip = 0;
        queryChats(skip, size);
        // btn.disabled = false;
    }).catch(err => {
        layer.msg('留言失败，请联系管理员');
        btn.disabled = false;
        console.log(err);
    })
}

// 重置
function reset() {
    document.getElementById("name").value = "";
    document.getElementById("email").value = "";
    document.getElementById("web").value = "";
    document.getElementById("msg").value = "";
}

// 初始化
queryChats(skip, size);

// 上一页
function previous(btn) {
    // 开始执行，先将按钮置为不可用，执行完后设置可用
    btn.disabled = true;
    if (skip == 0) {
        layer.msg('当前是第一页');
        btn.disabled = false;
        return;
    } else {
        skip = skip - size;
        queryChats(skip, size);
        var page = (parseInt(skip) / parseInt(size)) + parseInt(1);
        // btn.disabled = false;
    }
}

// 下一页
function next(btn) {
    // 开始执行，先将按钮置为不可用，执行完后设置可用
    btn.disabled = true;
    skip = skip + size;
    if (skip >= countSize) {
        // console.log(skip + ',' + countSize);
        skip = skip - size;
        layer.msg('当前是最后一页');
        btn.disabled = false;
        return;
    } else {
        queryChats(skip, size);
        var page = (parseInt(skip) / parseInt(size)) + parseInt(1);
        // btn.disabled = false;
    }
}

// 页面跳转
function jump() {
    layer.prompt({ title: '请输入页码', formType: 0 }, function (text, index) {
        layer.close(index);
        /* var reg = /^\d(\.\d)?$|^[1-9]\d(\.\d)?$/;
        if(reg.test(text)){
            if(text > pageSize){
                layer.msg('超过最大页码');
                return;
            }
            skip = (parseInt(text) - parseInt(1)) * size;
            queryChats(skip, size);
            layer.msg('跳转到第' + text + '页');
        }else{
            layer.msg('请输入1-99的正整数');
        } */
        if (text <= 0 || text >= 100) {
            layer.msg('请输入1-99的正整数');
            return;
        }
        if (text > pageSize) {
            layer.msg('超过最大页码');
            return;
        }
        skip = (parseInt(text) - parseInt(1)) * size;
        queryChats(skip, size);
        layer.msg('跳转到第' + text + '页');
    });
}

// 新建组件
var myDanmakuTpl = Vue.extend({
    template: '#danmakuTpl',
    props: {
        danmus: {
            type: Array,
            required: true
        },
        config: {
            type: Object,
            default: () => {
                return {}
            }
        }
    },
    data: function () {
        return {
            container: null,
            isActive: false,
            timer: null,
            $danmaku: null,
            $danmus: null,
            danmaku: {
                danmus: [],
                width: 0, // danmaku宽度
                channels: 0, // 轨道数量
                loop: false // 是否循环
            },
            danmu: {
                height: 30,
                fontSize: 18,
                speed: 5
            },
            hidden: false,
            paused: false,
            index: 0,
            continue: true,
            danChannel: {}
        }
    },
    // 启动时就执行
    mounted: function () {
        this.$nextTick(() => {
            this.init()
            this.$emit('inited')
        })
    },
    methods: {
        init() {
            this.initCore()
            this.initConfig()
        },
        reset() {
            this.initConfig()
        },
        mouseIn() {
            this.$emit('mouseIn')
        },
        mouseOut() {
            this.$emit('mouseOut')
        },
        initCore() {
            this.$danmaku = this.$refs.danmaku
            this.$danmus = this.$refs.danmus
        },
        initConfig() {
            this.danmaku.width = this.$danmaku.offsetWidth
            this.danmaku.height = this.$danmaku.offsetHeight
            this.danmaku.danmus = this.danmus
            this.danmaku.channels = this.config.channels || parseInt(this.danmaku.height / this.danmu.height)
            this.danmaku.loop = this.config.loop || this.danmaku.loop
            this.danmu.speed = this.config.speed || this.danmu.speed
            this.danmu.fontSize = this.config.fontSize || this.danmu.fontSize
        },
        play() {
            if (this.paused) {
                this.paused = false
                return
            }
            if (!this.timer) {
                this.draw()
            }
        },
        draw() {
            this.$nextTick(() => {
                this.timer = setInterval(() => {
                    if (this.index > this.danmus.length - 1) {
                        // console.log('1')
                        this.config.loop ? this.insert() : this.clear()
                    } else {
                        // console.log('2')
                        this.insert()
                    }
                }, 50)
            })
        },
        insert() {
            const index = this.config.loop ? this.index % this.danmus.length : this.index
            const el = document.createElement(`p`)
            if (this.continue) {
                el.classList.add(`dm`)
                el.classList.add(`move`)
                el.style.animationDuration = `${this.danmu.speed}s`
                el.style.fontSize = `${this.danmu.fontSize}px`
                el.innerHTML = this.danmus[index]
                el.setAttribute('index', this.index)
                this.$danmus.appendChild(el)
            }
            this.$nextTick(() => {
                let channelIndex = this.getChannel(el)
                if (channelIndex >= 0) {
                    this.continue = true
                    const width = el.offsetWidth
                    const height = this.danmu.height > this.danmu.fontSize ? this.danmu.height : this.danmu.fontSize + 4
                    el.style.top = channelIndex * height + 'px'
                    el.style.width = width + 1 + 'px'
                    el.style.transform = `translateX(-${this.danmaku.width}px)`
                    el.addEventListener('animationend', () => {
                        this.$danmus.removeChild(el)
                    })
                    if (el.classList.length > 0) {
                        this.index++
                    }
                } else {
                    if (el.classList.length > 0) {
                        this.$danmus.removeChild(el)
                    }
                }
            })
        },
        getChannel(el) {
            const tmp = this.$danmus.offsetWidth / ((this.$danmus.offsetWidth + el.offsetWidth) / 6)
            for (let i = 0; i < this.danmaku.channels; i++) {
                const items = this.danChannel[i + '']
                if (items && items.length) {
                    for (let j = 0; j < items.length; j++) {
                        const danRight = this.getDanRight(items[j]) - 10
                        if (danRight <= this.$danmus.offsetWidth - tmp * ((this.$danmus.offsetWidth + parseInt(items[j].offsetWidth)) / 6) || danRight <= 0) {
                            break
                        }
                        if (j === items.length - 1) {
                            this.danChannel[i + ''].push(el)
                            el.addEventListener('animationend', () => {
                                this.danChannel[i + ''].splice(0, 1)
                            })
                            return i % this.danmaku.channels
                        }
                    }
                } else {
                    this.danChannel[i + ''] = [el]
                    el.addEventListener('animationend', () => {
                        this.danChannel[i + ''].splice(0, 1)
                    })
                    return i % this.danmaku.channels
                }
            }
            return -1
        },
        // 弹幕到右侧的距离
        getDanRight(el) {
            const eleWidth = el.offsetWidth || parseInt(el.style.width)
            const eleRight = el.getBoundingClientRect().right || this.$danmus.getBoundingClientRect().right + eleWidth
            return this.$danmus.getBoundingClientRect().right - eleRight
        },
        // 添加弹幕
        add(danmu) {
            const index = this.index % this.danmaku.danmus.length
            this.danmaku.danmus.splice(index, 0, danmu)
        },
        pause() {
            this.paused = true
        },
        stop() {
            this.danChannel = {}
            this.$refs.danmus.innerHTML = ''
            this.paused = false
            this.hidden = false
            this.clear()
        },
        clear() {
            clearInterval(this.timer)
            this.timer = null
            this.index = 0
        },
        show() {
            this.hidden = false
        },
        hide() {
            this.hidden = true
        },
        resize() {
            this.initConfig()
            const items = this.$danmaku.getElementsByClassName('dm')
            for (let i = 0; i < items.length; i++) {
                items[i].style.transform = `translateX(-${this.danmaku.width}px)`
            }
        }
    }
});

// 全局注册组件每个Vue实例都可以使用
Vue.component('my-danmaku', myDanmakuTpl);

var myHome = new Vue({
    el: '#app',
    data: {
        config: {
            channels: 5,
            loop: true,
            speed: 15,
            fontSize: 18
        },
        danmus: []
    },
    // 启动时就执行
    mounted: function () {
        this.$nextTick(() => {
            this.queryData()
        })
    },
    methods: {
        queryData() {
            const query = Bmob.Query("chats");
            // 根据当前url查询数据
            query.equalTo("url", "==", url);
            if (getQueryString("type")) {
                // query.or(query.equalTo("type", '==', '0'), query.equalTo("type", '==', '1'));
                query.equalTo("type", '==', '1');
            } else {
                query.equalTo("type", '==', '0');
            }
            // 时间降序排列
            query.order("-date");
            query.find().then(res => {
                var msgArray = []
                for (var key in res) {
                    msgArray.push(res[key].msg)
                }
                // 判断手机还是PC
                var viewType = navigator.userAgent.toLowerCase()
                viewType = viewType.match(/(phone|pad|pod|midp|iphone|ipod|iphone os|ios|ipad|android|mobile|blackberry|iemobile|mqqbrowser|juc|rv:1.2.3.4|ucweb|fennec|wosbrowser|browserng|webos|symbian|windows ce|windows mobile|windows phone)/i)
                if (viewType) {
                    this.config.speed = 8
                }
                if (msgArray.length > 0) {
                    this.danmus = msgArray
                } else {
                    this.danmus = ['还没有留言哦~']
                }
                // console.log(this.danmus)
                this.$refs.myDanmaku.reset()
                this.$refs.myDanmaku.play()
            });
        }
    }
});